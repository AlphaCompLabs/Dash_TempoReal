# Testes Unit√°rios Automatizados - API Backend
Este documento descreve como configurar e executar a su√≠te de testes automatizados para a API RESTful do projeto. O objetivo destes testes √© garantir a confiabilidade, a corretude e a robustez do servidor backend, validando o comportamento de cada endpoint.

A implementa√ß√£o destes testes atende ao crit√©rio de avalia√ß√£o de **"Testes unit√°rios automatizados"**, contribuindo para a nota m√°xima do projeto.

## üõ†Ô∏è Ferramentas Utilizadas
**Pytest:** O framework utilizado como executor dos testes. Ele √© respons√°vel por encontrar, executar os testes e gerar os relat√≥rios.

**FastAPI TestClient:** Uma ferramenta fornecida pelo FastAPI que nos permite fazer requisi√ß√µes HTTP √† nossa API diretamente em mem√≥ria, sem a necessidade de rodar um servidor web real. Isso torna os testes extremamente r√°pidos e isolados.

**HTTPX:** A biblioteca que o `TestClient` usa por baixo dos panos para fazer as requisi√ß√µes ass√≠ncronas.

## ‚öôÔ∏è Configura√ß√£o do Ambiente de Teste
Para executar os testes, siga os passos abaixo. √â crucial que o **ambiente virtual `(venv)`** esteja ativo para garantir que todas as depend√™ncias corretas sejam utilizadas.

1. **Navegue at√© a Pasta Raiz do Projeto:**
Abra um terminal e certifique-se de que voc√™ est√° na pasta principal do projeto (a pasta que cont√©m as subpastas `BackEnd` e `Testes`).

2. Ative o Ambiente Virtual:
```
Se estiver usando PowerShell (padr√£o do VS Code)
.\venv\Scripts\activate

Se estiver usando Command Prompt (CMD)
venv\Scripts\activate
```

Voc√™ dever√° ver o ```(venv)``` aparecer no in√≠cio do prompt do seu terminal.

3. **Instale as Depend√™ncias (se ainda n√£o o fez):**
Garanta que todas as depend√™ncias do projeto, incluindo as de teste, estejam instaladas no seu ambiente virtual.
```
pip install -r requirements.txt
```
## üöÄ Como Executar os Testes
Com o ambiente virtual ativo e na pasta raiz do projeto, execute o seguinte comando:
```
pytest
```
O `pytest` ir√° descobrir e executar automaticamente todos os testes localizados na pasta `Testes/`. Ao final, ele apresentar√° um resumo dos resultados. Para uma sa√≠da mais detalhada, voc√™ pode usar a flag `-v`:
```
pytest -v
```
## ‚úÖ Valida√ß√µes Realizadas
A su√≠te de testes atual `(test_api.py)` foca em validar os "contratos" e a l√≥gica principal da nossa API.

1. **Fluxo Principal de Ingest√£o e Consumo `(test_ingest_and_get_traffic_data)`**
- **O qu√™:** Simula o `network_analyzer` enviando um payload de dados v√°lido para o endpoint `POST /api/ingest`.

- **Valida√ß√£o:** Em seguida, faz uma requisi√ß√£o `GET /api/traffic` e verifica se:

    - A resposta tem o status `200 OK`.

    - O corpo da resposta √© uma lista.

    - O n√∫mero de clientes na resposta corresponde ao que foi enviado.

    - Os valores de `inbound` e `outbound` para cada cliente est√£o corretos.

2. **Funcionalidade de Drill Down (`test_get_protocol_drilldown_data`)**
- **O qu√™:** Simula um clique do usu√°rio no dashboard, fazendo uma requisi√ß√£o ao endpoint GET /api/traffic/{client_ip}/protocols para um IP espec√≠fico.

- **Valida√ß√£o:** Verifica se:

    - A resposta tem o status `200 OK`.

     O corpo da resposta √© uma lista.

    - Os dados de protocolo est√£o formatados corretamente (`name` e `y`).

    - O valor y (tr√°fego total) para cada protocolo foi somado corretamente (`in_bytes + out_bytes`).

3. **Caminhos de Erro (Testes de Robustez)**
- **O qu√™**: Testa como a API se comporta em cen√°rios de erro.

- **Valida√ß√£o** (`test_get_drilldown_for_nonexistent_ip`): Tenta buscar o drill down para um IP que n√£o existe e verifica se a API retorna corretamente um erro `404 Not Found`.


TESTE REALIZADO NO DIA 29/09/2025:

 ======================================================================================= test session starts =======================================================================================
platform win32 -- Python 3.12.10, pytest-8.4.2, pluggy-1.6.0 -- C:\Users\diogo\OneDrive\√Årea de Trabalho\Back-End_API\servidores_teste\venv\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\diogo\OneDrive\√Årea de Trabalho\Back-End_API
plugins: anyio-4.10.0
collected 4 items                                                                                                                                                                                  

tests/test_Unit√°rio.py::test_ingest_and_get_traffic_data PASSED                                                                                                                              [ 25%]
tests/test_Unit√°rio.py::test_get_protocol_drilldown_data PASSED                                                                                                                              [ 50%]
tests/test_Unit√°rio.py::test_get_traffic_when_empty PASSED                                                                                                                                   [ 75%]
tests/test_Unit√°rio.py::test_get_protocol_for_nonexistent_client PASSED                                                                                                                      [100%]

======================================================================================== warnings summary =========================================================================================
BackEnd_RESTful\main.py:138
  C:\Users\diogo\OneDrive\√Årea de Trabalho\Back-End_API\BackEnd_RESTful\main.py:138: DeprecationWarning: 
          on_event is deprecated, use lifespan event handlers instead.
  
          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).

    @app.on_event("startup")

servidores_teste\venv\Lib\site-packages\fastapi\applications.py:4495
  C:\Users\diogo\OneDrive\√Årea de Trabalho\Back-End_API\servidores_teste\venv\Lib\site-packages\fastapi\applications.py:4495: DeprecationWarning:
          on_event is deprecated, use lifespan event handlers instead.

          Read more about it in the
          [FastAPI docs for Lifespan Events](https://fastapi.tiangolo.com/advanced/events/).

    return self.router.on_event(event_type)

servidores_teste\venv\Lib\site-packages\_pytest\cacheprovider.py:475
  C:\Users\diogo\OneDrive\√Årea de Trabalho\Back-End_API\servidores_teste\venv\Lib\site-packages\_pytest\cacheprovider.py:475: PytestCacheWarning: could not create cache path C:\Users\diogo\OneDrive\√Årea de Trabalho\Back-End_API\.pytest_cache\v\cache\nodeids: [WinError 5] Acesso negado: 'C:\\Users\\diogo\\OneDrive\\√Årea de Trabalho\\Back-End_API\\.pytest_cache\\v\\cache'
    config.cache.set("cache/nodeids", sorted(self.cached_nodeids))

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
================================================================================== 4 passed, 3 warnings in 0.48s ================================================================================== 
